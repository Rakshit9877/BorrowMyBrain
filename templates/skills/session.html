{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BorrowMyBrain - Live Session</title>
    <link rel="stylesheet" href="{% static 'css/session.css' %}">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <script src="https://unpkg.com/@daily-co/daily-js"></script>
</head>
<body>
    <div class="session-container">
        <header class="session-header">
            <div class="logo">
                <a href="{% url 'home' %}">BorrowMy<span class="brain-highlight">Brain</span></a>
            </div>
            <div class="session-info">
                <span class="session-title">{{ session_title|default:"Live Learning Session" }}</span>
                <span class="session-timer" id="timer">00:00:00</span>
            </div>
            <div class="user-profile">
                <img src="https://i.pravatar.cc/40?u={{ user.username }}" alt="User Avatar">
                <span>{{ user.get_full_name|default:user.username }}</span>
            </div>
        </header>

        <main class="session-main">
            <div class="video-area">
                <div id="call-frame" class="daily-call-frame" style="background: #111; display: flex; align-items: center; justify-content: center; color: white; font-size: 1.2rem; min-height: 320px;"></div>
                <div class="video-controls">
                    <div class="control-group">
                        <button class="control-button" id="micBtn"><i class="fas fa-microphone"></i></button>
                        <button class="control-button" id="videoBtn"><i class="fas fa-video"></i></button>
                        <button class="control-button" id="shareScreenBtn"><i class="fas fa-desktop"></i></button>
                    </div>
                    <div class="control-group">
                        <button class="control-button primary" id="getSummaryBtn">Get AI Summary</button>
                        <button class="control-button" id="recordBtn"><i class="fas fa-record-vinyl"></i></button>
                    </div>
                    <div class="control-group">
                        <button class="control-button leave-btn" id="leaveBtn"><i class="fas fa-phone-slash"></i></button>
                    </div>
                </div>
            </div>
            
            <div class="right-panel">
                <div class="transcription-area">
                    <div class="section-header">
                        <h3>Live Transcript</h3>
                        <button class="toggle-btn" id="toggleTranscript">
                            <i class="fas fa-chevron-up"></i>
                        </button>
                    </div>
                    <div id="transcript-container" class="content-container">
                        <p class="transcript-placeholder">Transcription will appear here once the session starts...</p>
                    </div>
                </div>
                
                <div class="summary-area">
                    <div class="section-header">
                        <h3>AI Session Summary</h3>
                        <button class="toggle-btn" id="toggleSummary">
                            <i class="fas fa-chevron-up"></i>
                        </button>
                    </div>
                    <div id="summary-container" class="content-container">
                        <p class="summary-placeholder">Click "Get AI Summary" to generate an intelligent session summary.</p>
                        <div id="summary-loading" class="loading-spinner" style="display: none;">
                            <i class="fas fa-spinner fa-spin"></i>
                            <span>Generating AI summary...</span>
                        </div>
                    </div>
                </div>

                <div class="session-notes">
                    <div class="section-header">
                        <h3>Session Notes</h3>
                        <button class="toggle-btn" id="toggleNotes">
                            <i class="fas fa-chevron-up"></i>
                        </button>
                    </div>
                    <div class="content-container">
                        <textarea id="notesArea" placeholder="Take notes during the session..."></textarea>
                        <button class="save-notes-btn" id="saveNotesBtn">Save Notes</button>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- Summary Modal -->
    <div id="summaryModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>AI-Generated Session Summary</h2>
                <span class="close-button">&times;</span>
            </div>
            <div class="modal-body">
                <div id="modal-summary-text"></div>
                <div class="modal-actions">
                    <button class="btn btn-primary" id="downloadSummaryBtn">Download Summary</button>
                    <button class="btn btn-secondary" id="shareSummaryBtn">Share Summary</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Connection Status -->
    <div id="connectionStatus" class="connection-status">
        <div class="status-indicator">
            <i class="fas fa-circle"></i>
            <span>Connecting...</span>
        </div>
    </div>

    <script>
        // Pass Django context variables to JavaScript
        window.sessionConfig = {
            roomUrl: "{{ daily_room_url }}",
            roomName: "{{ room_name }}",
            userId: "{{ user.id|default:'guest' }}",
            userName: "{{ user_name|default:'Guest User' }}",
            sessionId: "{{ session_id|default:'' }}",
            csrfToken: "{{ csrf_token }}",
            geminiApiKey: "{{ gemini_api_key|default:'' }}"
        };
        
                // Optional: initial transcript text (used only if Daily events not available)
                window.mockTranscript = window.mockTranscript || '';

                // Join Daily room if a URL is present
                (function initDaily(){
                    const url = window.sessionConfig?.roomUrl;
                    const container = document.getElementById('call-frame');
                    if (!url || !container || !window.DailyIframe) return;
                    try {
                        const frame = window.DailyIframe.createFrame(container, {
                            iframeStyle: {
                                width: '100%',
                                height: '100%',
                                minHeight: '320px',
                                border: '0',
                                borderRadius: '8px',
                                overflow: 'hidden'
                            }
                        });
                        frame.join({ url });

                        // Example transcript hook: capture chat messages as transcript lines (fallback if no real transcription)
                        frame.on('app-message', ev => {
                            const msg = ev?.data?.message;
                            if (msg) {
                                window.dispatchEvent(new CustomEvent('daily-transcript-line', { detail: { speaker: 'Participant', text: String(msg) } }));
                            }
                        });
                    } catch (e) {
                        console.warn('Daily join failed:', e);
                    }
                })();
    </script>
        <script src="{% static 'js/session_simple.js' %}"></script>
    </body>
</html>